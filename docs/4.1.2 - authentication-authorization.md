# Task 4.1.2 - Authentication and Authorization Implementation

## Overview

This document describes the comprehensive authentication and authorization system implemented for the E-Commerce Analytics Platform API, including JWT-based authentication, role-based access control (RBAC), API key management, and OAuth2 integration capabilities.

## Features Implemented

### 1. JWT-Based Authentication

- **Token Generation**: Secure JWT tokens with configurable expiration times
- **Password Security**: Bcrypt password hashing with strong validation requirements
- **Token Validation**: Automatic token verification for all protected endpoints
- **Refresh Tokens**: Support for refresh token flow (configured for 30-day expiration)

### 2. Role-Based Access Control (RBAC)

#### User Roles

- **Admin**: Full system access including user management and system administration
- **Analyst**: Read/write access to analytics, fraud detection, and business intelligence
- **Viewer**: Read-only access to analytics and reporting features
- **API User**: Programmatic access with limited permissions

#### Permissions System

Fine-grained permissions for specific operations:

- **Analytics**: `read:analytics`, `write:analytics`, `delete:analytics`
- **Customers**: `read:customers`, `write:customers`, `delete:customers`
- **Fraud Detection**: `read:fraud`, `write:fraud`, `manage:fraud_rules`
- **Business Intelligence**: `read:business_intelligence`, `write:business_intelligence`
- **System Administration**: `manage:users`, `manage:api_keys`, `manage:system`
- **Data Export**: `export:data`

### 3. API Key Management

- **Secure Key Generation**: Cryptographically secure API keys with `ecap_` prefix
- **Permission-Based**: API keys can have specific permissions assigned
- **Expiration Support**: Optional expiration dates for API keys
- **Usage Tracking**: Last used timestamps for monitoring
- **Revocation**: Admin ability to revoke API keys instantly

### 4. OAuth2 Integration

- **OAuth2 Password Flow**: Compatible with OAuth2 specification for third-party integrations
- **Swagger UI Integration**: Built-in authentication in API documentation
- **Standard Compliance**: Follows OAuth2 Bearer token standards

## API Endpoints

### Authentication Endpoints

#### `POST /api/v1/auth/login`
User login with username/email and password.

**Request:**
```json
{
  "username": "admin",
  "password": "secret"
}
```

**Response:**
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "token_type": "bearer",
  "expires_in": 86400
}
```

#### `POST /api/v1/auth/token`
OAuth2-compatible token endpoint for Swagger UI and third-party integrations.

#### `GET /api/v1/auth/me`
Get current authenticated user information.

**Response:**
```json
{
  "id": 1,
  "username": "admin",
  "email": "admin@example.com",
  "full_name": "System Administrator",
  "is_active": true,
  "role": "admin",
  "permissions": [],
  "created_at": "2025-01-23T00:00:00Z"
}
```

### User Management Endpoints (Admin Only)

#### `POST /api/v1/auth/users`
Create new user accounts.

#### `GET /api/v1/auth/users`
List all users with pagination.

#### `GET /api/v1/auth/users/{user_id}`
Get specific user details.

#### `PUT /api/v1/auth/users/{user_id}`
Update user information including roles and permissions.

#### `DELETE /api/v1/auth/users/{user_id}`
Delete user accounts.

#### `POST /api/v1/auth/change-password`
Change user password with current password verification.

### API Key Management Endpoints (Admin Only)

#### `POST /api/v1/auth/api-keys`
Create new API keys with specific permissions.

**Request:**
```json
{
  "name": "Analytics Service Key",
  "permissions": ["read:analytics", "read:customers"],
  "expires_at": "2025-12-31T23:59:59Z"
}
```

#### `GET /api/v1/auth/api-keys`
List all API keys.

#### `DELETE /api/v1/auth/api-keys/{api_key}`
Revoke API keys.

#### `GET /api/v1/auth/api-keys/verify`
Verify API key validity and permissions.

## Security Features

### Password Requirements

- Minimum 8 characters
- At least one uppercase letter
- At least one lowercase letter  
- At least one digit
- At least one special character

### Token Security

- **HS256 Algorithm**: Secure HMAC-SHA256 signing
- **Configurable Expiration**: Default 24 hours for access tokens
- **Secret Key Protection**: Environment-based secret key configuration
- **Payload Validation**: Comprehensive token payload verification

### API Key Security

- **Cryptographically Secure**: Generated using `secrets.token_urlsafe(32)`
- **Prefix Identification**: All keys start with `ecap_` for easy identification
- **Permission Scoping**: Keys limited to specific permissions only
- **Expiration Management**: Optional expiration dates

## Configuration

### Environment Variables

```bash
# Security settings
ECAP_SECRET_KEY=your-production-secret-key
ECAP_ACCESS_TOKEN_EXPIRE_MINUTES=1440  # 24 hours
ECAP_REFRESH_TOKEN_EXPIRE_DAYS=30

# CORS settings
ECAP_ALLOWED_ORIGINS=["http://localhost:3000", "https://yourapp.com"]
```

### Development vs Production

- **Development**: Debug mode enabled, relaxed CORS policy
- **Production**: Debug disabled, strict CORS policy, mandatory secret key change

## Usage Examples

### Using JWT Authentication

```python
import requests

# Login
login_response = requests.post("http://localhost:8000/api/v1/auth/login", json={
    "username": "admin",
    "password": "secret"
})
token = login_response.json()["access_token"]

# Use token for authenticated requests
headers = {"Authorization": f"Bearer {token}"}
user_response = requests.get("http://localhost:8000/api/v1/auth/me", headers=headers)
```

### Using API Key Authentication

```python
import requests

# Use API key for authenticated requests
headers = {"X-API-Key": "ecap_your_api_key_here"}
data_response = requests.get("http://localhost:8000/api/v1/analytics/customers", headers=headers)
```

### Role-Based Endpoint Protection

```python
from fastapi import Depends
from src.api.auth.dependencies import require_role, require_permission
from src.api.auth.models import UserRole, Permission

# Protect endpoint with role requirement
@app.get("/admin-only")
async def admin_endpoint(user = Depends(require_role(UserRole.ADMIN))):
    return {"message": "Admin access granted"}

# Protect endpoint with specific permission
@app.get("/analytics")
async def analytics_endpoint(user = Depends(require_permission(Permission.READ_ANALYTICS))):
    return {"data": "analytics data"}
```

## Integration with Existing Endpoints

The authentication system is designed to integrate seamlessly with existing API endpoints:

1. **Health Endpoints**: Remain public (no authentication required)
2. **Analytics Endpoints**: Protected with `read:analytics` permission
3. **Customer Endpoints**: Protected with `read:customers` permission
4. **Fraud Endpoints**: Protected with `read:fraud` permission

## Testing

Comprehensive test suite covers:

- JWT token generation and validation
- Password hashing and verification
- Role-based access control
- API key management
- Permission checking logic
- Error handling and edge cases

Run tests:
```bash
pytest tests/api/test_auth.py -v
```

## Development Notes

### Mock Implementation

For development and testing purposes, the authentication system includes:

- **Mock User Database**: In-memory user storage with default admin user
- **Mock API Keys**: Development API key for testing
- **Default Credentials**: `admin`/`secret` for initial development

### Future Database Integration

The system is designed to easily integrate with the existing PostgreSQL database:

1. Create user tables with proper relationships
2. Implement database queries in `AuthService`
3. Add user migrations with Alembic
4. Replace mock implementations with real database operations

### OAuth2 Provider Integration

The system supports OAuth2 integration with external providers:

1. Google OAuth2
2. GitHub OAuth2
3. Microsoft Azure AD
4. Custom OAuth2 providers

## Production Deployment

### Security Checklist

- [ ] Change default secret key
- [ ] Disable debug mode
- [ ] Configure proper CORS origins
- [ ] Set up HTTPS/TLS
- [ ] Implement rate limiting
- [ ] Set up monitoring and alerting
- [ ] Configure log retention policies
- [ ] Review and test all permissions

### Monitoring

Key metrics to monitor in production:

- Authentication success/failure rates
- Token usage patterns
- API key usage and abuse
- Permission violations
- Password change frequency
- Failed login attempts (potential attacks)

## Architecture Benefits

1. **Scalability**: Stateless JWT tokens support horizontal scaling
2. **Flexibility**: Role and permission system adapts to changing requirements
3. **Security**: Multiple layers of security with comprehensive validation
4. **Integration**: OAuth2 compatibility for third-party integrations
5. **Maintainability**: Clean separation of concerns and modular design
6. **Observability**: Comprehensive logging and monitoring capabilities

## Conclusion

The authentication and authorization system provides enterprise-grade security for the E-Commerce Analytics Platform while maintaining flexibility and ease of use. The implementation follows security best practices and industry standards, ensuring the platform can safely handle sensitive e-commerce analytics data.

The system is production-ready with proper configuration and database integration, supporting both human users through web interfaces and programmatic access through API keys.